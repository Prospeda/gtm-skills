<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Follow-Up Sequence</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #18181b;
      color: #fafafa;
      padding: 16px;
      line-height: 1.5;
    }
    .container { max-width: 600px; margin: 0 auto; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #27272a;
    }
    .header h1 { font-size: 18px; font-weight: 600; }
    .badge {
      background: #8b5cf620;
      color: #8b5cf6;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    .context-card {
      background: #27272a;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
    }
    .context-item { font-size: 12px; }
    .context-label { color: #71717a; }
    .context-value { color: #fafafa; font-weight: 500; }
    .timeline {
      position: relative;
      padding-left: 24px;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 7px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #3f3f46;
    }
    .email-step {
      position: relative;
      margin-bottom: 16px;
    }
    .step-dot {
      position: absolute;
      left: -24px;
      top: 16px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #27272a;
      border: 2px solid #8b5cf6;
    }
    .step-dot.active { background: #8b5cf6; }
    .email-card {
      background: #27272a;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .email-card:hover { border-color: #8b5cf650; }
    .email-card.expanded { border: 1px solid #8b5cf650; }
    .email-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .email-day {
      font-size: 11px;
      color: #8b5cf6;
      text-transform: uppercase;
      font-weight: 600;
    }
    .email-subject {
      font-size: 14px;
      font-weight: 500;
      margin-top: 4px;
    }
    .expand-icon {
      color: #71717a;
      transition: transform 0.2s;
    }
    .email-card.expanded .expand-icon { transform: rotate(180deg); }
    .email-body {
      padding: 0 16px 16px;
      font-size: 13px;
      color: #a1a1aa;
      display: none;
      border-top: 1px solid #3f3f46;
      padding-top: 12px;
      white-space: pre-wrap;
    }
    .email-card.expanded .email-body { display: block; }
    .email-actions {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #18181b;
      border-top: 1px solid #3f3f46;
      display: none;
    }
    .email-card.expanded .email-actions { display: flex; }
    .btn-sm {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-sm-primary { background: #8b5cf6; color: white; }
    .btn-sm-secondary { background: #3f3f46; color: #fafafa; }
    .triggers {
      background: #22c55e10;
      border: 1px solid #22c55e30;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }
    .triggers h3 { font-size: 13px; color: #22c55e; margin-bottom: 10px; }
    .triggers ul { font-size: 12px; color: #a1a1aa; padding-left: 16px; }
    .triggers li { margin-bottom: 6px; }
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      flex: 1;
      transition: all 0.2s;
    }
    .btn-primary { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
    .btn-secondary { background: #3f3f46; color: #fafafa; }
    .copied {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #22c55e;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .copied.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Follow-Up Sequence</h1>
      <span class="badge">4 Emails</span>
    </div>

    <div class="context-card">
      <div class="context-item">
        <span class="context-label">Contact:</span>
        <span class="context-value" id="contact-name">Loading...</span>
      </div>
      <div class="context-item">
        <span class="context-label">Company:</span>
        <span class="context-value" id="company-name">Loading...</span>
      </div>
      <div class="context-item">
        <span class="context-label">Days cold:</span>
        <span class="context-value" id="days-cold">-</span>
      </div>
    </div>

    <div class="timeline" id="timeline">
      <!-- Email steps will be rendered here -->
    </div>

    <div class="triggers">
      <h3>Re-Engagement Triggers</h3>
      <ul>
        <li id="trigger-news">Company in the news</li>
        <li id="trigger-job">Contact job change</li>
        <li id="trigger-linkedin">LinkedIn activity</li>
        <li>Industry trigger events</li>
      </ul>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="copy-btn">Copy Sequence</button>
      <button class="btn btn-secondary" id="export-btn">Export to CRM</button>
    </div>
  </div>

  <div class="copied" id="copied-toast">Copied to clipboard!</div>

  <script>
    let sequenceData = {
      contact: '',
      company: '',
      daysCold: 0,
      emails: [],
      content: ''
    };

    const timeline = document.getElementById('timeline');
    const contactName = document.getElementById('contact-name');
    const companyName = document.getElementById('company-name');
    const daysCold = document.getElementById('days-cold');
    const copyBtn = document.getElementById('copy-btn');
    const copiedToast = document.getElementById('copied-toast');

    function parseEmails(markdown) {
      const emails = [];
      const emailRegex = /## Email (\d+): Day (\d+)[^\n]*\n\n\*\*Subject:\*\* ([^\n]+)\n\n([\s\S]*?)(?=---|\n## Email|$)/g;
      let match;
      while ((match = emailRegex.exec(markdown)) !== null) {
        emails.push({
          number: parseInt(match[1]),
          day: parseInt(match[2]),
          subject: match[3].trim(),
          body: match[4].trim()
        });
      }
      return emails;
    }

    function renderTimeline() {
      timeline.innerHTML = sequenceData.emails.map((email, i) => `
        <div class="email-step">
          <div class="step-dot ${i === 0 ? 'active' : ''}"></div>
          <div class="email-card" data-index="${i}">
            <div class="email-header">
              <div>
                <div class="email-day">Day ${email.day}</div>
                <div class="email-subject">${email.subject}</div>
              </div>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="email-body">${email.body}</div>
            <div class="email-actions">
              <button class="btn-sm btn-sm-primary" data-copy="${i}">Copy</button>
              <button class="btn-sm btn-sm-secondary" data-edit="${i}">Edit</button>
            </div>
          </div>
        </div>
      `).join('');

      // Add click handlers
      timeline.querySelectorAll('.email-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('btn-sm')) {
            card.classList.toggle('expanded');
          }
        });
      });

      timeline.querySelectorAll('[data-copy]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const i = parseInt(btn.dataset.copy);
          const email = sequenceData.emails[i];
          await navigator.clipboard.writeText(`Subject: ${email.subject}\n\n${email.body}`);
          copiedToast.classList.add('show');
          setTimeout(() => copiedToast.classList.remove('show'), 2000);
        });
      });
    }

    function updateDisplay() {
      contactName.textContent = sequenceData.contact;
      companyName.textContent = sequenceData.company;
      daysCold.textContent = sequenceData.daysCold;
      renderTimeline();
    }

    copyBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(sequenceData.content);
      copiedToast.classList.add('show');
      setTimeout(() => copiedToast.classList.remove('show'), 2000);
    });

    window.addEventListener('message', (event) => {
      if (event.data.type === 'tool_result') {
        const c = event.data.content;
        sequenceData.contact = c.recipientName || 'Unknown';
        sequenceData.company = c.company || '';
        sequenceData.daysCold = c.daysSinceContact || 0;
        sequenceData.content = c.text || '';
        sequenceData.emails = parseEmails(c.text || '');
        updateDisplay();
      }
    });

    window.parent.postMessage({ jsonrpc: '2.0', method: 'ui/ready', id: Date.now() }, '*');

    // Default display with sample data
    sequenceData.emails = [
      { number: 1, day: 1, subject: 'Following up - [Company]', body: 'Hi [Name],\n\nWanted to follow up on our conversation...' },
      { number: 2, day: 4, subject: 'Thought you might find this useful', body: 'While you\'re thinking things over, I wanted to share...' },
      { number: 3, day: 7, subject: 'Quick question', body: 'Is this still something you\'re looking to address this quarter?' },
      { number: 4, day: 10, subject: 'Should I close your file?', body: 'I don\'t want to be that salesperson who won\'t take a hint...' }
    ];
    renderTimeline();
  </script>
</body>
</html>
